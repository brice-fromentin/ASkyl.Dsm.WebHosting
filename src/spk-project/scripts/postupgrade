#!/bin/bash

# Script executed after package upgrade

source "$(dirname "$0")/common-functions.sh"

# -----------------------------------------------------------------------------
# Initialization
# -----------------------------------------------------------------------------
update_progress 0.1 "Initializing upgrade"
start_log "postupgrade"
log_info "Starting post-upgrade script..."
log_debug "Package dir: $PACKAGE_DIR"
log_debug "Var dir: $VAR_DIR"

# -----------------------------------------------------------------------------
# Configuration Restore
# -----------------------------------------------------------------------------
update_progress 0.2 "Restoring configuration"
log_info "Restoring websites configuration..."
restore_file "$PACKAGE_DIR/admin-ui/websites.json"
log_info "Configuration restored."

# -----------------------------------------------------------------------------
# .NET Runtime Installation
# -----------------------------------------------------------------------------
update_progress 0.3 "Installing .NET runtime"
if ! install_dotnet_runtime; then
    # Error is logged inside the function
    exit 1
fi
log_info ".NET runtime installation step completed."

# -----------------------------------------------------------------------------
# .NET Runtime Verification
# -----------------------------------------------------------------------------
update_progress 0.8 "Verifying .NET runtime"
if ! verify_dotnet_runtime; then
    log_fatal_with_temp "Failed to verify .NET runtime installation after upgrade."
                       "The .NET runtime could not be installed or is corrupted."
    exit 1
fi
log_info ".NET runtime verification step completed."

# -----------------------------------------------------------------------------
# Finalization
# -----------------------------------------------------------------------------
update_progress 1.0 "Upgrade completed"
log_info "Post-upgrade script finished successfully."

exit 0
