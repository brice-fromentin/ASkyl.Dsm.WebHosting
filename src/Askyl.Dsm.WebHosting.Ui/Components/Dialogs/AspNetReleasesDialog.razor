@using Askyl.Dsm.WebHosting.Constants
@using Askyl.Dsm.WebHosting.Constants.Runtime
@using Askyl.Dsm.WebHosting.Tools.Runtime
@using Askyl.Dsm.WebHosting.Ui.Models

@implements IDialogContentComponent

@inject IDialogService DialogsService
@inject IFrameworkManagementService ManagementService
@inject IDotnetVersionService DotnetVersionService

<FluentOverlay @bind-Visible="@IsWorking" Opacity="0.7">
    <FluentStack Orientation="Orientation.Vertical" HorizontalAlignment="HorizontalAlignment.Center" VerticalAlignment="VerticalAlignment.Center">
        <FluentProgressRing Size="FluentProgressSize.Large" />
        <FluentLabel Typo="Typography.Header" Class="full-size">
            @(IsSelectedVersionInstalled ? "Uninstalling" : "Installing") ASP.NET Core @(SelectedItem?.Version ?? "")...
        </FluentLabel>
    </FluentStack>
</FluentOverlay>

<FluentDialogHeader ShowDismiss="true">
    <FluentLabel Typo="Typography.H2">ASP.NET Online</FluentLabel>
</FluentDialogHeader>

<FluentDialogFooter>
    <FluentButton OnClick="CancelAsync" Appearance="Appearance.Accent" Disabled="@IsWorking" Class="flex-full-width">Close</FluentButton>
</FluentDialogFooter>

<FluentDialogBody>
    <FluentToolbar Class="full-width">
        <FluentLabel>Channel</FluentLabel>

        <FluentSelect Items="@Channels" @bind-SelectedOption="@SelectedChannel" Width="140px" Disabled="@IsWorking" />

        <FluentButton OnClick="Refresh" Appearance="Appearance.Outline" Title="Refresh" Disabled="@IsWorking">
            <FluentIcon Value="@(new IconsRegular16.ArrowClockwise())" />
        </FluentButton>

        <FluentButton OnClick="@(IsSelectedVersionInstalled? UninstallSelectedFramework : InstallSelectedFramework)" Appearance="Appearance.Accent" Disabled="@(!CanProcessSelected || IsWorking)" Title="@GetActionButtonTooltip()" Class="flex-full-width">
            <FluentStack Orientation="Orientation.Horizontal" VerticalAlignment="VerticalAlignment.Center">
                <FluentIcon Value="@(IsSelectedVersionInstalled ? (Icon)new IconsRegular16.Delete() : new IconsRegular16.CloudArrowDown())" Color="Color.Fill" />
                <FluentLabel Color="Color.Fill">
                    @GetActionButtonText()
                </FluentLabel>
            </FluentStack>
        </FluentButton>
    </FluentToolbar>

    <div class="dialog-grid-container">
        <AutoDataGrid @ref="@Grid" TItem="AspNetRelease" GridTemplateColumns="100px 240px 120px 100px 120px">
            <ChildContent>
                <PropertyColumn TGridItem="AspNetRelease" TProp="string" Title="Version" Property="@(r => r.Version)" />
                <PropertyColumn TGridItem="AspNetRelease" TProp="string" Title="Installed" Property="@(r => r.Installed)" Align="Align.Center" />
                <PropertyColumn TGridItem="AspNetRelease" TProp="string" Title="Security" Property="@(r => r.Security)" Align="Align.Center" />
                <PropertyColumn TGridItem="AspNetRelease" TProp="string" Title="Release" Property="@(r => r.ReleaseDate)" />
            </ChildContent>
        </AutoDataGrid>
    </div>
</FluentDialogBody>

@code
{
    #region Properties and Fields

    [CascadingParameter]
    public FluentDialog Dialog { get; set; } = default!;

    private AutoDataGrid<AspNetRelease>? Grid { get; set; }

    private List<AspNetChannel> Channels { get; set; } = [];
    private IQueryable<AspNetRelease> Releases { get; set; } = Enumerable.Empty<AspNetRelease>().AsQueryable();
    private AspNetChannel? SelectedChannel
    {
        get => _selectedChannel;
        set
        {
            if (_selectedChannel != value)
            {
                _selectedChannel = value;
                InvokeAsync(async () => await LoadReleasesAsync(value));
            }
        }
    }
    private AspNetChannel? _selectedChannel;
    private bool IsWorking { get; set; } = false;
    private IEnumerable<AspNetRelease> SelectedItems { get; set; } = [];

    // Helper property for backward compatibility
    private AspNetRelease? SelectedItem => SelectedItems?.FirstOrDefault();

    #endregion

    #region Computed Properties

    private bool IsSelectedVersionInstalled => SelectedItem?.Installed.Equals("✓") == true;
    private bool CanProcessSelected => !IsWorking && SelectedItem != null;
    private bool CanInstallSelected => !IsWorking && SelectedItem != null && !SelectedItem.Installed.Equals("✓");

    #endregion

    #region UI Helper Methods

    private string GetActionButtonText()
    {
        if (SelectedItem == null)
        {
            return "Select a version";
        }

        return IsSelectedVersionInstalled ? $"Uninstall {SelectedItem.Version}" : $"Install {SelectedItem.Version}";
    }

    private string GetActionButtonTooltip()
    {
        if (IsWorking)
        {
            return IsSelectedVersionInstalled ? "Uninstallation in progress..." : "Installation in progress...";
        }

        if (SelectedItem == null)
        {
            return "Select a framework version";
        }

        return IsSelectedVersionInstalled ? $"Uninstall ASP.NET Core {SelectedItem.Version}" : $"Install ASP.NET Core {SelectedItem.Version}";
    }

    private string GetInstallButtonTooltip()
    {
        if (IsWorking)
        {
            return "Installation in progress...";
        }

        if (SelectedItem == null)
        {
            return "Select a framework version to install";
        }

        if (SelectedItem.Installed.Equals("✓"))
        {
            return $"Version {SelectedItem.Version} is already installed";
        }

        return $"Install ASP.NET Core {SelectedItem.Version}";
    }

    #endregion

    #region Lifecycle Methods

    protected override async Task OnParametersSetAsync()    => await LoadChannelsAsync();

    #endregion

    #region Dialog Management

    private async Task CancelAsync()    => await Dialog.CancelAsync();

    private async Task ShowErrorAsync(string error)    => await DialogsService.ShowErrorAsync(error);

    #endregion

    #region Data Loading

    private async Task LoadChannelsAsync()
    {
        IsWorking = true;

        try
        {
            Channels = await DotnetVersionService.GetAspNetChannelsAsync();

            if (SelectedChannel == null && Channels.Count > 0)
            {
                SelectedChannel = Channels.First();
            }
        }
        catch (Exception ex)
        {
            await ShowErrorAsync(ex.Message);
            Channels.Clear();
            SelectedChannel = null;
        }
        finally
        {
            IsWorking = false;
        }
    }

    private async Task LoadReleasesAsync(AspNetChannel? channel)
    {
        if (channel == null)
        {
            Releases = Enumerable.Empty<AspNetRelease>().AsQueryable();
            return;
        }

        try
        {
            var releases = await DotnetVersionService.GetAspNetReleasesWithStatusAsync(channel.ProductVersion);
            Releases = releases.AsQueryable();
        }
        catch (Exception ex)
        {
            await ShowErrorAsync(ex.Message);
            Releases = Enumerable.Empty<AspNetRelease>().AsQueryable();
        }
    }

    private async Task Refresh()
    {
        Releases = Enumerable.Empty<AspNetRelease>().AsQueryable();
        SelectedItems = [];

        if (Grid != null)
        {
            Grid.SetLoadingState(true);
            await LoadReleasesAsync(SelectedChannel);
            Grid.SetLoadingState(false);
        }
    }

    #endregion

    #region Framework Management

    private async Task InstallSelectedFramework()
    {
        if (!CanInstallSelected || SelectedItem == null)
        {
            return;
        }

        IsWorking = true;

        try
        {
            var result = await ManagementService.InstallFrameworkAsync(SelectedItem.Version, SelectedChannel?.ProductVersion ?? String.Empty);

            if (result.Success)
            {
                await DialogsService.ShowInfoAsync(result.Message);
                await Refresh(); // Refresh to update the installed status
            }
            else
            {
                await DialogsService.ShowErrorAsync(result.Message);
            }
        }
        catch (Exception ex)
        {
            await DialogsService.ShowErrorAsync($"Installation error: {ex.Message}");
        }
        finally
        {
            IsWorking = false;
        }
    }

    private async Task UninstallSelectedFramework()
    {
        if (!IsSelectedVersionInstalled || SelectedItem == null)
        {
            return;
        }

        var confirmationMessage = $"Click OK if you want to proceed with uninstalling ASP.NET Core {SelectedItem.Version}";
        var confirmation = await DialogsService.ShowConfirmationAsync(confirmationMessage);
        var result = await confirmation.Result;

        if (result == null || result.Cancelled)
        {
            return;
        }

        IsWorking = true;

        try
        {
            var uninstallResult = await ManagementService.UninstallFrameworkAsync(SelectedItem.Version);

            if (uninstallResult.Success)
            {
                await DialogsService.ShowInfoAsync(uninstallResult.Message);
                await Refresh();
            }
            else
            {
                await DialogsService.ShowErrorAsync(uninstallResult.Message);
            }
        }
        catch (Exception ex)
        {
            await DialogsService.ShowErrorAsync($"Uninstallation error: {ex.Message}");
        }
        finally
        {
            IsWorking = false;
        }
    }

    #endregion
}
