@using Askyl.Dsm.WebHosting.Constants
@using Askyl.Dsm.WebHosting.Constants.Runtime
@using Askyl.Dsm.WebHosting.Data.Runtime

@implements IDialogContentComponent

@inject IDialogService DialogService
@inject IDotnetVersionService DotnetVersionService

<FluentDialogHeader ShowDismiss="true">
    <FluentLabel Typo="Typography.H2">.NET Versions</FluentLabel>
</FluentDialogHeader>

<FluentDialogFooter>
    <FluentButton OnClick="CancelAsync" Appearance="Appearance.Accent">Close</FluentButton>
</FluentDialogFooter>

<FluentDialogBody>
    @if (IsLoading)
    {
        <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.Center">
            <FluentProgressRing />
            <FluentLabel>Searching for .NET versions...</FluentLabel>
        </FluentStack>
    }
    else if (DotnetVersions?.Any() == true)
    {
        <FluentCard>
            <FluentStack Orientation="Orientation.Vertical">
                @foreach (var framework in DotnetVersions)
                {
                    <FluentStack Orientation="Orientation.Horizontal" VerticalAlignment="VerticalAlignment.Center">
                        <FluentIcon Value="@GetFrameworkIcon(framework.Type)" />
                        <FluentLabel Typo="Typography.Body">
                            <strong>@framework.Type:</strong> @framework.Version
                        </FluentLabel>
                    </FluentStack>
                }
            </FluentStack>
        </FluentCard>
    }
    else if (ErrorMessage != null)
    {
        <FluentStack Orientation="Orientation.Horizontal" VerticalAlignment="VerticalAlignment.Center">
            <FluentIcon Value="@(new IconsRegular24.Warning())" Color="Color.Error" />
            <FluentLabel Typo="Typography.Body" Color="Color.Error">
                @ErrorMessage
            </FluentLabel>
        </FluentStack>
    }
    else
    {
        <FluentStack Orientation="Orientation.Horizontal" VerticalAlignment="VerticalAlignment.Center">
            <FluentIcon Value="@(new IconsRegular24.Info())" Color="Color.Warning" />
            <FluentLabel Typo="Typography.Body">
                No .NET installation found. Make sure .NET is installed.
            </FluentLabel>
        </FluentStack>
    }
</FluentDialogBody>

@code
{
    #region Properties and Fields

    [CascadingParameter]
    public FluentDialog Dialog { get; set; } = default!;

    private bool IsLoading { get; set; } = false;
    private List<FrameworkInfo>? DotnetVersions { get; set; }
    private string? ErrorMessage { get; set; }

    #endregion

    #region Lifecycle Methods

    protected override async Task OnParametersSetAsync()
        => await LoadDotnetVersions();

    #endregion

    #region Dialog Management

    private async Task CancelAsync()
        => await Dialog.CancelAsync();

    #endregion

    #region Data Loading

    private async Task LoadDotnetVersions()
    {
        IsLoading = true;
        ErrorMessage = null;

        try
        {
            DotnetVersions = await DotnetVersionService.GetInstalledVersionsAsync();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error while searching for global .NET version: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
        }
    }

    #endregion

    #region UI Helper Methods

    private Icon GetFrameworkIcon(string frameworkType)
    {
        return frameworkType switch
        {
            DotNetFrameworkTypes.SdkMain => new IconsRegular16.Star(),
            DotNetFrameworkTypes.Sdk => new IconsRegular16.Settings(),
            DotNetFrameworkTypes.AspNetCore => new IconsRegular16.Globe(),
            DotNetFrameworkTypes.Runtime => new IconsRegular16.Play(),
            _ => new IconsRegular16.Code()
        };
    }

    #endregion
}