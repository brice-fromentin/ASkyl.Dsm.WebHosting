@page "/"

@using Askyl.Dsm.WebHosting.Constants.Application
@using Askyl.Dsm.WebHosting.Data.WebSites
@using Askyl.Dsm.WebHosting.Tools.Network
@using Askyl.Dsm.WebHosting.Ui.Components.Patterns.WorkingState
@using Askyl.Dsm.WebHosting.Ui.Extensions
@using Askyl.Dsm.WebHosting.Ui.Models.Results

@implements IWorkingState

@inject IDialogService DialogsService
@inject DsmApiClient client
@inject NavigationManager navigation
@inject ILogDownloadService logDownloadService
@inject ITemporaryTokenService tokenService
@inject WebSiteHostingService hostingService

<PageTitle>ADWH - Home</PageTitle>

<LoadingOverlay WorkingStateComponent="@this" />

<FluentToolbar Class="full-width">
    <FluentButton IconStart="@(new IconsRegular20.Add())" Appearance="Appearance.Neutral" OnClick="AddWebSite">
        Add
    </FluentButton>
    <FluentButton IconStart="@(new IconsRegular20.Edit())" Appearance="Appearance.Neutral" Disabled="@(SelectedInstance is null)" OnClick="EditWebSite">
        Edit
    </FluentButton>
    <FluentButton IconStart="@(new IconsRegular20.Delete())" Appearance="Appearance.Neutral" Disabled="@(SelectedInstance is null)" OnClick="DeleteWebSite">
        Delete
    </FluentButton>
    <FluentDivider Role="DividerRole.Separator" Orientation="Orientation.Vertical" />
    <FluentButton Appearance="Appearance.Neutral" Disabled="@(SelectedInstance is null || SelectedInstance.IsRunning)" OnClick="StartSelectedInstance" >
        <FluentIcon Value="@(new IconsRegular20.Play())" Color="Color.Success" />    
    </FluentButton>
    <FluentButton Appearance="Appearance.Neutral" Disabled="@(SelectedInstance is null || !SelectedInstance.IsRunning)" OnClick="StopSelectedInstance" >
        <FluentIcon Value="@(new IconsRegular20.Stop())" Color="Color.Error" />    
    </FluentButton>
    <FluentSpacer />
    <FluentButton OnClick="ShowDotnetVersionsDialog" Appearance="Appearance.Outline">
        .NET Version
    </FluentButton>
    <FluentButton OnClick="ShowAspNetReleasesDialog" Appearance="Appearance.Outline">
        ASP.NET Online
    </FluentButton>
    <FluentButton OnClick="DownloadLogs" Appearance="Appearance.Outline">
        Download Logs
    </FluentButton>
</FluentToolbar>

<AutoDataGrid TItem="WebSiteInstance" Items="@Instances" OnReload="@LoadInstancesAsync" OnRowClick="@HandleInstanceSelected" OnRowDoubleClick="@EditWebSiteInstance" GridTemplateColumns="1fr 2fr 1fr 1fr">
    <ChildContent>
        <PropertyColumn TGridItem="WebSiteInstance" TProp="string" Title="Name" Property="@(i => i.Configuration.Name)" Sortable="true" />
        <PropertyColumn TGridItem="WebSiteInstance" TProp="string" Title="Path" Property="@(i => i.Configuration.ApplicationPath)" Sortable="true" />
        <PropertyColumn TGridItem="WebSiteInstance" TProp="int" Title="Internal Port" Property="@(i => i.Configuration.InternalPort)" Sortable="true" />
        <PropertyColumn TGridItem="WebSiteInstance" TProp="string" Title="State" Property="@(i => i.State)" Sortable="true" />
    </ChildContent>
</AutoDataGrid>

@code
{
    #region IWorkingState Implementation

    public bool IsWorking { get; set; }
    public string Message { get; set; } = "";

    public void NotifyStateChanged() => StateHasChanged();

    #endregion

    #region Properties and Fields

    private IQueryable<WebSiteInstance> Instances { get; set; } = AutoDataGrid<WebSiteInstance>.Empty();

    private WebSiteInstance? SelectedInstance { get; set; }

    #endregion

    #region Lifecycle Methods

    protected override async Task OnInitializedAsync()
    {
        if (!client.IsConnected)
        {
            navigation.NavigateTo("/login");
            return;
        }

        await LoadInstancesAsync();
    }

    #endregion

    #region Data Loading

    private async Task LoadInstancesAsync()
    {
        try
        {
            var instances = hostingService.GetInstances();
            Instances = instances.AsQueryable();
        }
        catch (Exception ex)
        {
            await DialogsService.ShowErrorAsync($"Error loading instances: {ex.Message}");
            Instances = AutoDataGrid<WebSiteInstance>.Empty();
        }
        finally
        {
            StateHasChanged();
        }
    }

    #endregion

    #region Dialog Management

    private async Task ShowDotnetVersionsDialog() => await DialogsService.ShowDialogAsync<DotnetVersionsDialog>();

    private async Task ShowAspNetReleasesDialog() => await DialogsService.ShowDialogAsync<AspNetReleasesDialog>();

    private async Task AddWebSite() => await ShowWebSiteConfigurationDialogAsync(WebSiteInstance.New());

    private async Task EditWebSite() => await ShowWebSiteConfigurationDialogAsync(SelectedInstance);

    private async Task EditWebSiteInstance(WebSiteInstance instance) => await ShowWebSiteConfigurationDialogAsync(instance);

    private async Task DeleteWebSite()
    {
        if (SelectedInstance is null)
        {
            return;
        }

        var dialog = await DialogsService.ShowConfirmationAsync($"Are you sure you want to delete '{SelectedInstance.Configuration.Name}'?");
        var confirmResult = await dialog.Result;

        if (confirmResult.Cancelled)
        {
            return;
        }

        var siteName = SelectedInstance.Configuration.Name;

        using var worker = this.CreateWorkingState($"Deleting '{siteName}'...");

        await Task.Delay(100);

        var result = await hostingService.RemoveInstanceAsync(SelectedInstance.Id);
        await HandleOperationResultAsync(result, $"Site '{siteName}' deleted successfully.");

        if (result.Success)
        {
            SelectedInstance = null;
            await LoadInstancesAsync();
        }
    }

    private async Task ShowWebSiteConfigurationDialogAsync(WebSiteInstance? instance)
    {
        if (instance is null)
        {
            return;
        }

        var dialog = await DialogsService.ShowDialogAsync<WebSiteConfigurationDialog>(instance, "600px");
        var result = await dialog.Result;

        if (!result.Cancelled)
        {
            await LoadInstancesAsync();
        }
    }

    #endregion

    #region Instance Selection

    private void HandleInstanceSelected(WebSiteInstance instance) => SelectedInstance = instance;

    #endregion

    #region Instance Lifecycle

    private async Task StartSelectedInstance()
    {
        if (SelectedInstance is null)
        {
            return;
        }

        using var worker = this.CreateWorkingState($"Starting site '{SelectedInstance.Configuration.Name}'...");

        await Task.Delay(100);

        var result = await hostingService.StartSiteAsync(SelectedInstance);
        await HandleOperationResultAsync(result, $"Site '{SelectedInstance.Configuration.Name}' started successfully.");
    }

    private async Task StopSelectedInstance()
    {
        if (SelectedInstance is null)
        {
            return;
        }

        using var worker = this.CreateWorkingState($"Stopping site '{SelectedInstance.Configuration.Name}'...");

        await Task.Delay(100);

        var result = await hostingService.StopSiteAsync(SelectedInstance);
        await HandleOperationResultAsync(result, $"Site '{SelectedInstance.Configuration.Name}' stopped successfully.");
    }

    private async Task HandleOperationResultAsync(OperationResult result, string successMessage)
    {
        if (result.Success)
        {
            await DialogsService.ShowSuccessAsync(successMessage);
        }
        else
        {
            await DialogsService.ShowErrorAsync(result.ErrorMessage!);
        }
    }

    #endregion

    #region Log Management

    private async Task DownloadLogs()
    {
        try
        {
            // Generate temporary token for authentication
            var token = tokenService.GenerateToken();

            if (String.IsNullOrEmpty(token))
            {
                await DialogsService.ShowErrorAsync("Authentication required. Please make sure you are connected to DSM.");
                return;
            }

            // Direct navigation to trigger download (no popup)
            var downloadUrl = $"{LogConstants.LogDownloadEndpoint}?{LogConstants.TokenQueryParameter}={Uri.EscapeDataString(token)}";
            navigation.NavigateTo(downloadUrl, forceLoad: true);
        }
        catch (Exception ex)
        {
            await DialogsService.ShowErrorAsync($"Error downloading logs: {ex.Message}");
        }
    }

    #endregion
}